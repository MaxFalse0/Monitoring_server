{% extends "base.html" %}
{% block title %}Графики{% endblock %}
{% block content %}
<h1 class="page-title">Мониторинг в реальном времени</h1>

<div class="grid-gauges">
    <div class="gauge-box" onclick="toggleDetails('cpu')">
        <canvas id="cpuGauge"></canvas>
        <div class="chart-value" id="cpuValue">--%</div>
        <div class="gauge-label">Процессор</div>
        <div class="gauge-details" id="details-cpu" style="display:none;"></div>
    </div>
    <div class="gauge-box" onclick="toggleDetails('ram')">
        <canvas id="ramGauge"></canvas>
        <div class="chart-value" id="ramValue">--%</div>
        <div class="gauge-label">Оперативная память</div>
        <div class="gauge-details" id="details-ram" style="display:none;"></div>
    </div>
    <div class="gauge-box" onclick="toggleDetails('disk')">
        <canvas id="diskGauge"></canvas>
        <div class="chart-value" id="diskValue">--%</div>
        <div class="gauge-label">Диск</div>
        <div class="gauge-details" id="details-disk" style="display:none;"></div>
    </div>
    <div class="gauge-box" onclick="toggleDetails('temp')">
        <canvas id="tempGauge"></canvas>
        <div class="chart-value" id="tempValue">--°C</div>
        <div class="gauge-label">Температура</div>
        <div class="gauge-details" id="details-temp" style="display:none;"></div>
    </div>
    <div class="gauge-box" onclick="toggleDetails('users')">
        <canvas id="usersGauge"></canvas>
        <div class="chart-value" id="usersValue">--</div>
        <div class="gauge-label">Пользователи</div>
        <div class="gauge-details" id="details-users" style="display:none;"></div>
    </div>
</div>

<p style="margin-top:20px;">Последнее обновление: <span id="last-update">--:--</span></p>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
<script>
const gauges = {
    cpu: 'cpuGauge',
    ram: 'ramGauge',
    disk: 'diskGauge',
    temp: 'tempGauge',
    users: 'usersGauge'
};
const charts = {};

function createGauge(ctx, label) {
    return new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: [label],
            datasets: [{
                data: [0, 100],
                backgroundColor: ['#5a5f72', '#2c2c2c'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            cutout: '70%',
            rotation: 270,
            circumference: 180,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            }
        }
    });
}

for (const key in gauges) {
    const ctx = document.getElementById(gauges[key]).getContext('2d');
    charts[key] = createGauge(ctx, key.toUpperCase());
}

function updateDetails(key, label, value, min, max, unit = '%') {
    const details = `
        <div class="gauge-extra">
            <p><strong>Среднее:</strong> ${value}${unit}</p>
            <p><strong>Мин:</strong> ${min}${unit}</p>
            <p><strong>Макс:</strong> ${max}${unit}</p>
        </div>
    `;
    document.getElementById("details-" + key).innerHTML = details;
}

function updateGauges(data) {
    if (!data) return;

    charts.cpu.data.datasets[0].data = [data.cpu, 100 - data.cpu];
    charts.ram.data.datasets[0].data = [data.ram, 100 - data.ram];
    charts.disk.data.datasets[0].data = [data.disk, 100 - data.disk];
    charts.temp.data.datasets[0].data = [data.temp, 100 - data.temp];
    charts.users.data.datasets[0].data = [data.users, Math.max(0, 50 - data.users)];

    charts.cpu.update();
    charts.ram.update();
    charts.disk.update();
    charts.temp.update();
    charts.users.update();

    document.getElementById("cpuValue").textContent = data.cpu + "%";
    document.getElementById("ramValue").textContent = data.ram + "%";
    document.getElementById("diskValue").textContent = data.disk + "%";
    document.getElementById("tempValue").textContent = data.temp + "°C";
    document.getElementById("usersValue").textContent = data.users;

    updateDetails("cpu", "CPU", data.cpu_avg, data.cpu_min, data.cpu_max);
    updateDetails("ram", "RAM", data.ram_avg, data.ram_min, data.ram_max);
    updateDetails("disk", "Disk", data.disk_avg, data.disk_min, data.disk_max);
    updateDetails("temp", "Temp", data.temp_avg, data.temp_min, data.temp_max, "°C");
    updateDetails("users", "Пользователи", data.users_avg, data.users_min, data.users_max, "");

    document.getElementById("last-update").textContent = new Date().toLocaleTimeString();
}

function toggleDetails(key) {
    const block = document.getElementById("details-" + key);
    block.style.display = block.style.display === "none" ? "block" : "none";
}

setInterval(() => {
    fetch("/data")
        .then(res => res.json())
        .then(data => updateGauges(data.metrics));
}, 3000);

const socket = io();
socket.on("new_metrics", (data) => updateGauges(data));
</script>
{% endblock %}
