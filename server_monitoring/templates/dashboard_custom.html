{% extends "base.html" %}
{% block title %}Графики{% endblock %}
{% block content %}
<h1 class="page-title">Мониторинг в реальном времени</h1>

<div class="grid-gauges">
    {% for metric in ['cpu', 'ram', 'disk', 'temp', 'users', 'rx', 'tx'] %}
    <div class="gauge-box" {% if metric not in ['rx', 'tx'] %}onclick="toggleDetails('{{ metric }}')" {% endif %}>
        <canvas id="{{ metric }}Gauge"></canvas>
        <div class="chart-value" id="{{ metric }}Value">--</div>
        <div class="gauge-label">
            {% if metric == 'cpu' %}Процессор{% elif metric == 'ram' %}Оперативная память{% elif metric == 'disk' %}Диск
            {% elif metric == 'temp' %}Температура{% elif metric == 'users' %}Пользователи
            {% elif metric == 'rx' %}Сеть ↓ (RX){% elif metric == 'tx' %}Сеть ↑ (TX){% endif %}
        </div>
        {% if metric not in ['rx', 'tx'] %}
        <div class="gauge-details" id="details-{{ metric }}" style="display:none;"></div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<p style="margin-top:20px;">Последнее обновление: <span id="last-update">--:--</span></p>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
<script>
const gauges = {
    cpu: 'cpuGauge',
    ram: 'ramGauge',
    disk: 'diskGauge',
    temp: 'tempGauge',
    users: 'usersGauge',
    rx: 'rxGauge',
    tx: 'txGauge'
};

const charts = {};
const history = {
    cpu: [],
    ram: [],
    disk: [],
    temp: [],
    users: []
};
const netHistory = { rx: [], tx: [] };

function createGauge(ctx) {
    return new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [0, 100],
                backgroundColor: ['#5a5f72', '#2c2c2c'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            cutout: '70%',
            rotation: 270,
            circumference: 180,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            }
        }
    });
}

for (const key in gauges) {
    const ctx = document.getElementById(gauges[key]).getContext('2d');
    charts[key] = createGauge(ctx);
}

function formatNetSpeed(bytes) {
    const b = parseFloat(bytes);
    if (isNaN(b) || b < 0) return "0 B/s";
    if (b >= 1024 * 1024) return (b / (1024 * 1024)).toFixed(2) + " MB/s";
    if (b >= 1024) return (b / 1024).toFixed(1) + " KB/s";
    return b.toFixed(0) + " B/s";
}

function scaleNetDynamic(value, historyArr) {
    const b = parseFloat(value);
    if (isNaN(b)) {
        historyArr.push(0);
        return [0, 100];
    }
    historyArr.push(b);
    if (historyArr.length > 50) historyArr.shift();
    const peak = Math.max(...historyArr, 1);
    const percent = Math.min((b / peak) * 100, 100);
    return [percent, 100 - percent];
}

function updateHistory(key, value) {
    const arr = history[key];
    arr.push(value);
    if (arr.length > 50) arr.shift();
    const avg = arr.reduce((a, b) => a + b, 0) / arr.length;
    const min = Math.min(...arr);
    const max = Math.max(...arr);
    return { avg: avg.toFixed(2), min: min.toFixed(2), max: max.toFixed(2) };
}

function updateDetails(key, label, value, min, max, unit = '%') {
    const details = `
        <div class="gauge-extra">
            <p><strong>Среднее:</strong> ${value}${unit}</p>
            <p><strong>Мин:</strong> ${min}${unit}</p>
            <p><strong>Макс:</strong> ${max}${unit}</p>
        </div>
    `;
    const block = document.getElementById("details-" + key);
    if (block) block.innerHTML = details;
}

function updateGauges(data) {
    if (!data) return;

    const cpuStats = updateHistory("cpu", data.cpu);
    const ramStats = updateHistory("ram", data.ram);
    const diskStats = updateHistory("disk", data.disk);
    const tempStats = updateHistory("temp", data.temp ?? 0);
    const usersStats = updateHistory("users", data.users);

    charts.cpu.data.datasets[0].data = [data.cpu, 100 - data.cpu];
    charts.ram.data.datasets[0].data = [data.ram, 100 - data.ram];
    charts.disk.data.datasets[0].data = [data.disk, 100 - data.disk];
    charts.temp.data.datasets[0].data = [data.temp ?? 0, 100 - (data.temp ?? 0)];
    charts.users.data.datasets[0].data = [data.users, Math.max(0, 50 - data.users)];

    const rxVal = parseFloat(data.net_rx ?? data.rx ?? 0);
    const txVal = parseFloat(data.net_tx ?? data.tx ?? 0);

    charts.rx.data.datasets[0].data = scaleNetDynamic(rxVal, netHistory.rx);
    charts.tx.data.datasets[0].data = scaleNetDynamic(txVal, netHistory.tx);

    for (let key in charts) charts[key].update();

    document.getElementById("cpuValue").textContent = data.cpu + "%";
    document.getElementById("ramValue").textContent = data.ram + "%";
    document.getElementById("diskValue").textContent = data.disk + "%";
    document.getElementById("tempValue").textContent = data.temp && data.temp > 0 ? data.temp + "°C" : "N/A";
    document.getElementById("usersValue").textContent = data.users;
    document.getElementById("rxValue").textContent = formatNetSpeed(rxVal);
    document.getElementById("txValue").textContent = formatNetSpeed(txVal);

    updateDetails("cpu", "CPU", cpuStats.avg, cpuStats.min, cpuStats.max);
    updateDetails("ram", "RAM", ramStats.avg, ramStats.min, ramStats.max);
    updateDetails("disk", "Disk", diskStats.avg, diskStats.min, diskStats.max);
    updateDetails("temp", "Temp", tempStats.avg, tempStats.min, tempStats.max, "°C");
    updateDetails("users", "Пользователи", usersStats.avg, usersStats.min, usersStats.max, "");

    document.getElementById("last-update").textContent = new Date().toLocaleTimeString();
}

function toggleDetails(key) {
    const block = document.getElementById("details-" + key);
    block.style.display = block.style.display === "none" ? "block" : "none";
}

setInterval(() => {
    fetch("/data")
        .then(res => res.json())
        .then(data => updateGauges(data.metrics));
}, 3000);

const socket = io();
socket.on("new_metrics", (data) => updateGauges(data));
</script>
{% endblock %}
