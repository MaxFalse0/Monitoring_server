{% extends "base.html" %}
{% block title %}–ì—Ä–∞—Ñ–∏–∫–∏{% endblock %}
{% block content %}
<h1 class="page-title">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h1>

<!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –∫–Ω–æ–ø–∫–∞ "–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è" -->
<div class="status-bar island" style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <strong>–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</strong>
        <span id="conn-status" style="color: var(--success);">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    </div>
    <form method="get" action="{{ url_for('disconnect') }}">
        <button type="submit" id="disconnect-btn" style="display:none;" class="btn danger">üîå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
    </form>
</div>

<!-- –°–µ—Ç–∫–∞ –¥–ª—è 9 –º–µ—Ç—Ä–∏–∫ -->
<div class="grid-gauges">
    {% set gauges_map = {
        'cpu': '–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä',
        'ram': '–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å',
        'disk': '–î–∏—Å–∫',
        'temp': '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞',
        'users': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
        'swap': '–ü–æ–¥–∫–∞—á–∫–∞',
        'rx': '–°–µ—Ç—å ‚Üì (RX)',
        'tx': '–°–µ—Ç—å ‚Üë (TX)',
        'power': '–≠–Ω–µ—Ä–≥–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ'
    } %}
    {% for metric, label in gauges_map.items() %}
    <div class="gauge-box">
        <div class="gauge-container clickable"
             onclick="toggleDetails('{{ metric }}')"
             title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –°—Ä–µ–¥–Ω–µ–µ/–ú–∏–Ω/–ú–∞–∫—Å">
            <canvas id="{{ metric }}Gauge"></canvas>
            <div class="chart-value" id="{{ metric }}Value">--</div>
        </div>
        <div class="gauge-label">{{ label }}</div>
        <div class="gauge-details" id="details-{{ metric }}" style="display: none;"></div>
    </div>
    {% endfor %}
</div>

<!-- –°–µ–∫—Ü–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
<div class="sys-info">
    <h2>–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
    <div class="info-grid">
        <div class="info-card">
            <strong>Uptime:</strong>
            <span id="uptime-value">--</span>
        </div>
        <div class="info-card">
            <strong>–ü—Ä–æ—Ü–µ—Å—Å—ã:</strong>
            <span id="processes-value">--</span>
        </div>
        <div class="info-card">
            <strong>–ü–æ—Ç–æ–∫–∏:</strong>
            <span id="threads-value">--</span>
        </div>
        <div class="info-card">
            <strong>–û—à–∏–±–∫–∏ RX:</strong>
            <span id="rx_err-value">--</span>
        </div>
        <div class="info-card">
            <strong>–û—à–∏–±–∫–∏ TX:</strong>
            <span id="tx_err-value">--</span>
        </div>
    </div>
</div>

<p style="margin-top:20px;">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="last-update">--:--</span></p>

<!-- –°—Ç–∏–ª–∏ -->
<style>
    /* –°–µ—Ç–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤: 3-4 –≥—Ä–∞—Ñ–∏–∫–∞ –≤ —Ä—è–¥ */
    .grid-gauges {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 25px;
        justify-items: center;
        margin-bottom: 30px;
    }
    .gauge-box {
        text-align: center;
        width: 210px;
    }
    .gauge-container {
        position: relative;
        width: 160px;
        height: 160px;
        margin: 0 auto;
    }
    .gauge-container canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    .chart-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
        color: #e0e0e0;
        font-size: 1.1rem;
        pointer-events: none;
    }
    .gauge-label {
        margin-top: 10px;
        font-size: 0.95rem;
        color: #ccc;
    }
    .gauge-details {
        margin-top: 10px;
        padding: 8px 10px;
        background: #2a2d33;
        border-radius: 6px;
        font-size: 0.9rem;
        color: #ddd;
        box-shadow: 0 0 5px rgba(0,0,0,0.4);
        transition: max-height 0.3s ease, opacity 0.3s ease;
    }
    .gauge-container.clickable {
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    .gauge-container.clickable:hover {
        transform: scale(1.03);
        box-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
    }
    /* –°–µ–∫—Ü–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
    .sys-info {
        margin-top: 30px;
    }
    .sys-info h2 {
        color: #ccc;
        font-size: 1.1rem;
        margin-bottom: 15px;
    }
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 15px;
    }
    .info-card {
        background: #2a2d33;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 0 5px rgba(0,0,0,0.4);
        color: #ddd;
        font-size: 0.9rem;
        text-align: center;
    }
</style>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Chart.js –∏ Socket.IO -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>

<script>
/* –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫—É —Å ID canvas */
const gauges = {
    cpu: 'cpuGauge',
    ram: 'ramGauge',
    disk: 'diskGauge',
    temp: 'tempGauge',
    users: 'usersGauge',
    swap: 'swapGauge',
    rx: 'rxGauge',
    tx: 'txGauge',
    power: 'powerGauge'
};

/* –ò—Å—Ç–æ—Ä–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–∏—Ö, –º–∏–Ω–∏–º—É–º –∏ –º–∞–∫—Å–∏–º—É–º */
const historyData = {
    cpu: [],
    ram: [],
    disk: [],
    temp: [],
    users: [],
    swap: [],
    rx: [],
    tx: [],
    power: []
};

/* –û–±—ä–µ–∫—Ç—ã Chart.js –¥–ª—è –∫–∞–∂–¥–æ–≥–æ gauge */
const charts = {};

/* –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è gauge-–¥–∏–∞–≥—Ä–∞–º–º—ã */
function createGauge(ctx) {
    return new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [0, 100],
                backgroundColor: ['#5a5f72', '#2c2c2c'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: false,
            cutout: '70%',
            rotation: 270,
            circumference: 180,
            plugins: {
                legend: {display: false},
                tooltip: {enabled: false}
            }
        }
    });
}

/* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–µ gauge */
for (const key in gauges) {
    const ctx = document.getElementById(gauges[key]).getContext('2d');
    charts[key] = createGauge(ctx);
}

/* –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–µ—Ç–∏ */
function formatNetSpeed(val) {
    const b = parseFloat(val);
    if (isNaN(b) || b <= 0) return "0 B/s";
    if (b >= 1024 * 1024) return (b / (1024 * 1024)).toFixed(2) + " MB/s";
    if (b >= 1024) return (b / 1024).toFixed(1) + " KB/s";
    return b.toFixed(0) + " B/s";
}

/* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —à–∫–∞–ª–∞ –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ (rx –∏ tx) */
function scaleNetDynamic(value, arr) {
    const b = parseFloat(value);
    arr.push(isNaN(b) ? 0 : b);
    if (arr.length > 50) arr.shift();
    const peak = Math.max(...arr, 1);
    const percent = Math.min((b / peak) * 100, 100);
    return [percent, 100 - percent];
}

/* –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –º–µ—Ç—Ä–∏–∫–∏ */
function updateHistory(metric, value) {
    const arr = historyData[metric];
    arr.push(value);
    if (arr.length > 50) arr.shift();
    const sum = arr.reduce((a, b) => a + b, 0);
    const avg = sum / arr.length;
    const min = Math.min(...arr);
    const max = Math.max(...arr);
    return {
        avg: avg.toFixed(2),
        min: min.toFixed(2),
        max: max.toFixed(2)
    };
}

/* –ó–∞–ø–æ–ª–Ω—è–µ–º –±–ª–æ–∫ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ */
function fillDetails(metric, stats, unit='%') {
    const block = document.getElementById("details-" + metric);
    if (!block) return;
    const avgStr = isNaN(parseFloat(stats.avg)) ? "N/A" : stats.avg + unit;
    const minStr = isNaN(parseFloat(stats.min)) ? "N/A" : stats.min + unit;
    const maxStr = isNaN(parseFloat(stats.max)) ? "N/A" : stats.max + unit;
    block.innerHTML = `
        <p style="margin:4px 0;"><strong>–°—Ä–µ–¥–Ω–µ–µ:</strong> ${avgStr}</p>
        <p style="margin:4px 0;"><strong>–ú–∏–Ω:</strong> ${minStr}</p>
        <p style="margin:4px 0;"><strong>–ú–∞–∫—Å:</strong> ${maxStr}</p>
    `;
}

/* –û—Å–Ω–æ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ gauge –∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π */
function updateGauges(data) {
    if (!data) return;

    // –û–±–Ω–æ–≤–ª—è–µ–º gauge: CPU, RAM, Disk, Temp, Users, Swap
    charts.cpu.data.datasets[0].data = [data.cpu, 100 - data.cpu];
    charts.ram.data.datasets[0].data = [data.ram, 100 - data.ram];
    charts.disk.data.datasets[0].data = [data.disk, 100 - data.disk];

    let t = data.temp ?? 0;
    if (t < 0) t = 0;
    if (t > 100) t = 100;
    charts.temp.data.datasets[0].data = [t, 100 - t];

    let u = data.users ?? 0;
    if (u < 0) u = 0;
    if (u > 100) u = 100;
    charts.users.data.datasets[0].data = [u, 100 - u];

    let s = data.swap ?? 0;
    if (s < 0) s = 0;
    if (s > 100) s = 100;
    charts.swap.data.datasets[0].data = [s, 100 - s];

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ç—å (rx, tx) —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π —à–∫–∞–ª–æ–π
    const rxVal = data.rx ?? 0;
    const txVal = data.tx ?? 0;
    const rxScaled = scaleNetDynamic(rxVal, historyData.rx);
    const txScaled = scaleNetDynamic(txVal, historyData.tx);
    charts.rx.data.datasets[0].data = rxScaled;
    charts.tx.data.datasets[0].data = txScaled;

    // –≠–Ω–µ—Ä–≥–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ: –Ω–æ—Ä–º–∏—Ä—É–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0..1000 W -> –¥–µ–ª–∏–º –Ω–∞ 10)
    let p = data.power ?? 0;
    if (p < 0) p = 0;
    if (p > 1000) p = 1000;
    charts.power.data.datasets[0].data = [p / 10, 100 - (p / 10)];

    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
    for (let key in charts) {
        charts[key].update();
    }

    // –§–∏–∫—Å–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
    document.getElementById("cpuValue").textContent = data.cpu + "%";
    document.getElementById("ramValue").textContent = data.ram + "%";
    document.getElementById("diskValue").textContent = data.disk + "%";
    document.getElementById("tempValue").textContent = (data.temp && data.temp > 0) ? data.temp + "¬∞C" : "N/A";
    document.getElementById("usersValue").textContent = data.users;
    document.getElementById("swapValue").textContent = data.swap + "%";
    document.getElementById("rxValue").textContent = formatNetSpeed(rxVal);
    document.getElementById("txValue").textContent = formatNetSpeed(txVal);
    document.getElementById("powerValue").textContent = data.power + " W";

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏ –¥–µ—Ç–∞–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–∏
    const cpuStats = updateHistory('cpu', data.cpu);
    const ramStats = updateHistory('ram', data.ram);
    const diskStats = updateHistory('disk', data.disk);
    const tempStats = updateHistory('temp', data.temp ?? 0);
    const userStats = updateHistory('users', data.users ?? 0);
    const swapStats = updateHistory('swap', data.swap ?? 0);
    const rxStats = updateHistory('rx', rxVal);
    const txStats = updateHistory('tx', txVal);
    const powerStats = updateHistory('power', data.power ?? 0);

    fillDetails('cpu', cpuStats);
    fillDetails('ram', ramStats);
    fillDetails('disk', diskStats);
    fillDetails('temp', tempStats, '¬∞C');
    fillDetails('users', userStats, '');
    fillDetails('swap', swapStats, '%');
    fillDetails('rx', rxStats, ' B/s');
    fillDetails('tx', txStats, ' B/s');
    fillDetails('power', powerStats, ' W');

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    document.getElementById("last-update").textContent = new Date().toLocaleTimeString();

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    document.getElementById("uptime-value").textContent = data.uptime;
    document.getElementById("processes-value").textContent = data.processes;
    document.getElementById("threads-value").textContent = data.threads;
    document.getElementById("rx_err-value").textContent = data.rx_err;
    document.getElementById("tx_err-value").textContent = data.tx_err;
}

/* –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è */
function updateConnectionStatus(statusData) {
    const connStatus = document.getElementById("conn-status");
    const disconnectBtn = document.getElementById("disconnect-btn");
    if (!statusData || !statusData.status || !statusData.active || statusData.status.includes("–û—à–∏–±–∫–∞")) {
        connStatus.textContent = "–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ";
        connStatus.style.color = "var(--danger)";
        disconnectBtn.style.display = "none";
    } else {
        connStatus.textContent = statusData.server ? `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ ${statusData.server}` : statusData.status;
        connStatus.style.color = "var(--success)";
        disconnectBtn.style.display = "inline-block";
    }
}

/* –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å /data */
function fetchStatus() {
    fetch("/data")
        .then(res => res.json())
        .then(data => {
            updateConnectionStatus(data.status);
            updateGauges(data.metrics);
        });
}
setInterval(fetchStatus, 3000);
fetchStatus();

/* Socket.IO –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ */
const socket = io();
socket.on("new_metrics", (data) => updateGauges(data));

/* –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∫–ª–∏–∫–µ */
function toggleDetails(metric) {
    const block = document.getElementById("details-" + metric);
    if (!block) return;
    block.style.display = (block.style.display === "none" || block.style.display === "") ? "block" : "none";
}
</script>
{% endblock %}
