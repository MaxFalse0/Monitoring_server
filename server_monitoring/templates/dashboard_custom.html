{% extends "base.html" %}
{% block title %}–ì—Ä–∞—Ñ–∏–∫–∏{% endblock %}
{% block content %}
<h1 class="page-title">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h1>

<!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –∫–Ω–æ–ø–∫–∞ "–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è" -->
<div class="status-bar island" style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <strong>–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</strong>
        <span id="conn-status" style="color: var(--success);">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    </div>
    <form method="get" action="{{ url_for('disconnect') }}">
        <button type="submit" id="disconnect-btn" style="display:none;" class="btn danger">üîå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
    </form>
</div>

<!-- –°–µ—Ç–∫–∞ –¥–ª—è 7 –º–µ—Ç—Ä–∏–∫ -->
<div class="grid-gauges">

    {% set metrics_map = {
        'cpu': '–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä',
        'ram': '–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å',
        'disk': '–î–∏—Å–∫',
        'temp': '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞',
        'users': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
        'rx': '–°–µ—Ç—å ‚Üì (RX)',
        'tx': '–°–µ—Ç—å ‚Üë (TX)'
    } %}
    {% for metric, label in metrics_map.items() %}
    <div class="gauge-box">
        <div class="gauge-container clickable"
             onclick="toggleDetails('{{ metric }}')"
             title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –°—Ä–µ–¥–Ω–µ–µ/–ú–∏–Ω/–ú–∞–∫—Å">
            <canvas id="{{ metric }}Gauge"></canvas>
            <div class="chart-value" id="{{ metric }}Value">--</div>
        </div>
        <div class="gauge-label">{{ label }}</div>
        <div class="gauge-details" id="details-{{ metric }}" style="display: none;"></div>
    </div>
    {% endfor %}

</div>

<p style="margin-top:20px;">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="last-update">--:--</span></p>

<!-- –°—Ç–∏–ª–∏ –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤, —Å–µ—Ç–∫–∏ –∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π -->
<style>
    /* –°–µ—Ç–∫–∞ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤: –ø–æ 3-4 –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —Ä—è–¥—É */
    .grid-gauges {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        gap: 25px;
        justify-items: center;
    }
    .gauge-box {
        text-align: center;
        width: 210px;
    }
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ (canvas) –∏ —á–∏—Å–ª–∞ */
    .gauge-container {
        position: relative;
        width: 160px;
        height: 160px;
        margin: 0 auto;
    }
    .gauge-container canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    .chart-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
        color: #e0e0e0;
        font-size: 1.1rem;
        pointer-events: none;
    }
    .gauge-label {
        margin-top: 10px;
        font-size: 0.95rem;
        color: #ccc;
    }
    .gauge-details {
        margin-top: 10px;
        padding: 8px 10px;
        background: #2a2d33;
        border-radius: 6px;
        font-size: 0.9rem;
        color: #ddd;
        box-shadow: 0 0 5px rgba(0,0,0,0.4);
    }
    .gauge-container.clickable {
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    .gauge-container.clickable:hover {
        transform: scale(1.03);
        box-shadow: 0 0 8px rgba(255,255,255,0.2);
    }
</style>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Chart.js –∏ Socket.IO -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>

<script>
/* –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ -> ID canvas */
const gauges = {
  cpu: 'cpuGauge',
  ram: 'ramGauge',
  disk: 'diskGauge',
  temp: 'tempGauge',
  users: 'usersGauge',
  rx: 'rxGauge',
  tx: 'txGauge'
};

/* –ò—Å—Ç–æ—Ä–∏—è –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å—Ä–µ–¥–Ω–∏—Ö/–º–∏–Ω/–º–∞–∫—Å –∑–Ω–∞—á–µ–Ω–∏–π */
const historyData = {
  cpu: [],
  ram: [],
  disk: [],
  temp: [],
  users: [],
  rx: [],
  tx: []
};

/* –û–±—ä–µ–∫—Ç—ã Chart.js –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ */
const charts = {};

/* –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è gauge (–ø–æ–ª—É–∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã) */
function createGauge(ctx) {
    return new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [0, 100],
                backgroundColor: ['#5a5f72', '#2c2c2c'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: false,
            cutout: '70%',
            rotation: 270,
            circumference: 180,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            }
        }
    });
}

/* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ */
for (const key in gauges) {
    const ctx = document.getElementById(gauges[key]).getContext('2d');
    charts[key] = createGauge(ctx);
}

/* –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–µ—Ç–∏ (B/s -> KB/s -> MB/s) */
function formatNetSpeed(val) {
    const b = parseFloat(val);
    if (isNaN(b) || b <= 0) return "0 B/s";
    if (b >= 1024 * 1024) return (b / (1024 * 1024)).toFixed(2) + " MB/s";
    if (b >= 1024) return (b / 1024).toFixed(1) + " KB/s";
    return b.toFixed(0) + " B/s";
}

/* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —à–∫–∞–ª–∞ –¥–ª—è RX –∏ TX */
function scaleNetDynamic(value, netArr) {
    const b = parseFloat(value);
    netArr.push(isNaN(b) ? 0 : b);
    if (netArr.length > 50) netArr.shift();
    const peak = Math.max(...netArr, 1);
    const percent = Math.min((b / peak) * 100, 100);
    return [percent, 100 - percent];
}

/* –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –º–∏–Ω/–º–∞–∫—Å/—Å—Ä–µ–¥–Ω–µ–≥–æ */
function updateHistory(metric, value) {
    const arr = historyData[metric];
    arr.push(value);
    if (arr.length > 50) arr.shift();
    const sum = arr.reduce((a, b) => a + b, 0);
    const avg = sum / arr.length;
    const min = Math.min(...arr);
    const max = Math.max(...arr);
    return {
        avg: avg.toFixed(2),
        min: min.toFixed(2),
        max: max.toFixed(2)
    };
}

/* –ó–∞–ø–æ–ª–Ω—è–µ–º –±–ª–æ–∫ –¥–µ—Ç–∞–ª–µ–π (—Å—Ä–µ–¥–Ω–µ–µ, –º–∏–Ω, –º–∞–∫—Å) –¥–ª—è –º–µ—Ç—Ä–∏–∫–∏ */
function fillDetails(metric, stats, unit='%') {
    const block = document.getElementById("details-" + metric);
    if (!block) return;
    block.innerHTML = `
        <p style="margin:4px 0;"><strong>–°—Ä–µ–¥–Ω–µ–µ:</strong> ${stats.avg}${unit}</p>
        <p style="margin:4px 0;"><strong>–ú–∏–Ω:</strong> ${stats.min}${unit}</p>
        <p style="margin:4px 0;"><strong>–ú–∞–∫—Å:</strong> ${stats.max}${unit}</p>
    `;
}

/* –û—Å–Ω–æ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π */
function updateGauges(data) {
    if (!data) return;

    // CPU, RAM, Disk ‚Äî –∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç 0 –¥–æ 100
    charts.cpu.data.datasets[0].data = [data.cpu, 100 - data.cpu];
    charts.ram.data.datasets[0].data = [data.ram, 100 - data.ram];
    charts.disk.data.datasets[0].data = [data.disk, 100 - data.disk];

    // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏–º –¥–æ 0..100 –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
    let t = data.temp ?? 0;
    if (t < 0) t = 0;
    if (t > 100) t = 100;
    charts.temp.data.datasets[0].data = [t, 100 - t];

    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Äî –æ—Ç 0 –¥–æ 100
    let u = data.users ?? 0;
    if (u < 0) u = 0;
    if (u > 100) u = 100;
    charts.users.data.datasets[0].data = [u, 100 - u];

    // –°–µ—Ç—å: –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é —à–∫–∞–ª—É (–ø–æ–ª—è "rx" –∏ "tx")
    const rxVal = data.rx ?? 0;
    const txVal = data.tx ?? 0;
    const rxScaled = scaleNetDynamic(rxVal, historyData.rx);
    const txScaled = scaleNetDynamic(txVal, historyData.tx);
    charts.rx.data.datasets[0].data = rxScaled;
    charts.tx.data.datasets[0].data = txScaled;

    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
    for (let key in charts) {
        charts[key].update();
    }

    // –§–∏–∫—Å–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ü–µ–Ω—Ç—Ä–µ
    document.getElementById("cpuValue").textContent = data.cpu + "%";
    document.getElementById("ramValue").textContent = data.ram + "%";
    document.getElementById("diskValue").textContent = data.disk + "%";
    document.getElementById("tempValue").textContent = (data.temp && data.temp > 0) ? data.temp + "¬∞C" : "N/A";
    document.getElementById("usersValue").textContent = data.users;
    document.getElementById("rxValue").textContent = formatNetSpeed(rxVal);
    document.getElementById("txValue").textContent = formatNetSpeed(txVal);

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–∏
    const cpuStats  = updateHistory('cpu', data.cpu);
    const ramStats  = updateHistory('ram', data.ram);
    const diskStats = updateHistory('disk', data.disk);
    const tempStats = updateHistory('temp', data.temp ?? 0);
    const userStats = updateHistory('users', data.users ?? 0);
    const rxStats   = updateHistory('rx', rxVal);
    const txStats   = updateHistory('tx', txVal);

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã—Ö –±–ª–æ–∫–æ–≤
    fillDetails('cpu',  cpuStats);
    fillDetails('ram',  ramStats);
    fillDetails('disk', diskStats);
    fillDetails('temp', tempStats, '¬∞C');
    fillDetails('users', userStats, '');
    fillDetails('rx',   rxStats, ' B/s');
    fillDetails('tx',   txStats, ' B/s');

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    document.getElementById("last-update").textContent = new Date().toLocaleTimeString();
}

/* –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è */
function updateConnectionStatus(statusData) {
    const connStatus = document.getElementById("conn-status");
    const disconnectBtn = document.getElementById("disconnect-btn");

    if (!statusData || !statusData.status || !statusData.active || statusData.status.includes("–û—à–∏–±–∫–∞")) {
        connStatus.textContent = "–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ";
        connStatus.style.color = "var(--danger)";
        disconnectBtn.style.display = "none";
    } else {
        connStatus.textContent = statusData.server ? `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ ${statusData.server}` : statusData.status;
        connStatus.style.color = "var(--success)";
        disconnectBtn.style.display = "inline-block";
    }
}

/* –û–ø—Ä–æ—Å /data –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã */
function fetchStatus() {
    fetch("/data")
        .then(res => res.json())
        .then(data => {
            updateConnectionStatus(data.status);
            updateGauges(data.metrics);
        });
}
setInterval(fetchStatus, 3000);
fetchStatus();

/* Socket.IO –¥–ª—è –ø—Ä—è–º–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –º–µ—Ç—Ä–∏–∫ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) */
const socket = io();
socket.on("new_metrics", (data) => updateGauges(data));

/* –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –±–ª–æ–∫–∞ */
function toggleDetails(metric) {
    const block = document.getElementById("details-" + metric);
    if (!block) return;
    block.style.display = (block.style.display === "none" || block.style.display === "") ? "block" : "none";
}
</script>
{% endblock %}
